{% extends "base_ios.html" %}

{% block title %}Corsi{% endblock %}

{% set large_title = "Corsi" %}
{% set fab_url = url_for('corsi.aggiungi_corso') %}
{% set fab_title = "Nuovo Corso" %}
{% set fab_icon = "‚ûï" %}

{% block navbar %}
    {% set title = "Corsi" %}
    {% set right_button_url = url_for('archivio.corsi_archiviati') %}
    {% set right_button_text = "Archiviati" %}
    {% include 'components/ios_navbar.html' %}
{% endblock %}

{% block content %}
<input type="hidden" id="csrf_token" value="{{ csrf_token() }}">

{% if corsi %}

<!-- Barra azioni multiple (appare solo quando si selezionano corsi) -->
<div id="barra-azioni" style="display:none;" class="barra-azioni-multi">
    <span id="contatore-selezionati" class="contatore-sel">0 selezionati</span>
    <div class="azioni-multi-btn">
        <button class="ios-button ios-button-warning ios-button-sm" id="archivia-corsi-button">üìÅ Archivia</button>
        <button class="ios-button ios-button-danger ios-button-sm" id="elimina-corsi-button">üóëÔ∏è Elimina</button>
    </div>
</div>

<!-- Seleziona tutti -->
<div class="seleziona-tutti-row">
    <label class="ios-checkbox">
        <input type="checkbox" id="selectAllCorsi">
        <span class="ios-checkbox-mark"></span>
        <span style="font-size:14px; color: var(--ios-secondary-label);">Seleziona tutti</span>
    </label>
</div>

<div class="ios-list-group" id="lista-corsi">
    {% for corso in corsi %}
    <div class="ios-corso-item {% if corso.completamente_fatturato %}corso-fatturato{% elif corso.parzialmente_fatturato %}corso-parziale{% else %}corso-non-fatturato{% endif %}">
        <!-- Checkbox di selezione -->
        <div class="corso-checkbox-wrap">
            <label class="ios-checkbox">
                <input class="corso-checkbox" type="checkbox" value="{{ corso.id_corso }}">
                <span class="ios-checkbox-mark"></span>
            </label>
        </div>

        <!-- Link ai dettagli -->
        <a href="{{ url_for('corsi.dettagli_corso', corso=corso.id_corso) }}" class="corso-main-content">
            <div class="corso-info">
                <div class="corso-nome">
                    {{ corso.nome }}
                    <span class="corso-id-badge">{{ corso.id_corso }}</span>
                </div>
                {% if corso.cliente %}
                <div class="corso-cliente">üë§ {{ corso.cliente }}</div>
                {% endif %}
                <div class="corso-stats">
                    <span class="stat-pill">üìö {{ corso.ore_totali|round(1) }}h totali</span>
                    {% if corso.ore_fatturate > 0 %}
                    <span class="stat-pill stat-green">üí∞ {{ corso.ore_fatturate|round(1) }}h fatt.</span>
                    {% endif %}
                    {% if corso.ore_rimanenti > 0 %}
                    <span class="stat-pill stat-orange">‚è≥ {{ corso.ore_rimanenti|round(1) }}h rimaste</span>
                    {% endif %}
                </div>
            </div>
            <div class="corso-right">
                {% if corso.completamente_fatturato %}
                    <span class="stato-badge stato-green">‚úÖ Fatturato</span>
                {% elif corso.parzialmente_fatturato %}
                    <span class="stato-badge stato-orange">‚ö° Parziale</span>
                {% else %}
                    <span class="stato-badge stato-gray">‚è≥ Da fatturare</span>
                {% endif %}
                <span class="ios-list-chevron"></span>
            </div>
        </a>

        <!-- Azioni inline -->
        <div class="corso-azioni">
            <a href="{{ url_for('corsi.modifica_corso', id_corso=corso.id_corso) }}" class="ios-button ios-button-secondary ios-button-sm">‚úèÔ∏è</a>

            {% if corso.completamente_fatturato %}
            <form action="{{ url_for('corsi.archivia_corso', id_corso=corso.id_corso) }}" method="POST" class="d-inline"
                  onsubmit="return confirm('üìÅ Archiviare il corso {{ corso.id_corso }}?');">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" class="ios-button ios-button-warning ios-button-sm">üìÅ</button>
            </form>
            {% endif %}

            <form action="{{ url_for('corsi.elimina_corso', id_corso=corso.id_corso) }}" method="POST" class="d-inline"
                  onsubmit="return confirm('‚ùå Eliminare definitivamente il corso {{ corso.id_corso }} e tutte le sue lezioni?');">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" class="ios-button ios-button-danger ios-button-sm">üóëÔ∏è</button>
            </form>
        </div>
    </div>
    {% endfor %}
</div>

{% else %}
<div class="ios-empty-state">
    <div class="ios-empty-icon">üìö</div>
    <h3 class="ios-empty-title">Nessun corso</h3>
    <p class="ios-empty-message">Aggiungi il tuo primo corso per iniziare a gestire le lezioni</p>
    <a href="{{ url_for('corsi.aggiungi_corso') }}" class="ios-button ios-button-primary">
        ‚ûï Nuovo Corso
    </a>
</div>
{% endif %}

<style>
/* ---- Barra azioni multiple ---- */
.barra-azioni-multi {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 16px;
    background: var(--ios-card-background);
    border-bottom: 0.5px solid var(--ios-separator);
    margin-bottom: 4px;
    position: sticky;
    top: 0;
    z-index: 100;
}

.contatore-sel {
    font-size: 14px;
    font-weight: 600;
    color: var(--ios-blue);
}

.azioni-multi-btn {
    display: flex;
    gap: 8px;
}

/* ---- Seleziona tutti ---- */
.seleziona-tutti-row {
    padding: 8px 16px 4px;
    display: flex;
    align-items: center;
}

/* ---- Item corso ---- */
.ios-corso-item {
    display: flex;
    align-items: center;
    padding: 12px 16px;
    background: var(--ios-card-background);
    border-bottom: 0.5px solid var(--ios-separator);
    gap: 10px;
    transition: background 0.15s;
}

.ios-corso-item:last-child {
    border-bottom: none;
}

.corso-checkbox-wrap {
    flex-shrink: 0;
}

.corso-main-content {
    flex: 1;
    display: flex;
    align-items: center;
    gap: 8px;
    text-decoration: none;
    color: inherit;
    min-width: 0;
}

.corso-info {
    flex: 1;
    min-width: 0;
}

.corso-nome {
    font-size: 15px;
    font-weight: 600;
    color: var(--ios-label);
    display: flex;
    align-items: center;
    gap: 6px;
    flex-wrap: wrap;
}

.corso-id-badge {
    display: inline-block;
    padding: 1px 6px;
    background: var(--ios-gray5, #E5E5EA);
    color: var(--ios-secondary-label);
    border-radius: 6px;
    font-size: 11px;
    font-weight: 500;
}

.corso-cliente {
    font-size: 13px;
    color: var(--ios-secondary-label);
    margin-top: 2px;
}

.corso-stats {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
    margin-top: 6px;
}

.stat-pill {
    font-size: 11px;
    padding: 2px 8px;
    border-radius: 10px;
    background: var(--ios-gray6, #F2F2F7);
    color: var(--ios-secondary-label);
    font-weight: 500;
}

.stat-green { background: rgba(52,199,89,0.12); color: var(--ios-green, #34C759); }
.stat-orange { background: rgba(255,149,0,0.12); color: var(--ios-orange, #FF9500); }

.corso-right {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 4px;
    flex-shrink: 0;
}

.stato-badge {
    font-size: 11px;
    font-weight: 600;
    padding: 3px 8px;
    border-radius: 10px;
    white-space: nowrap;
}

.stato-green { background: rgba(52,199,89,0.12); color: var(--ios-green, #34C759); }
.stato-orange { background: rgba(255,149,0,0.12); color: var(--ios-orange, #FF9500); }
.stato-gray { background: var(--ios-gray6, #F2F2F7); color: var(--ios-secondary-label); }

/* Colore bordo sinistro in base allo stato */
.corso-fatturato { border-left: 3px solid var(--ios-green, #34C759); }
.corso-parziale  { border-left: 3px solid var(--ios-orange, #FF9500); }
.corso-non-fatturato { border-left: 3px solid var(--ios-gray3, #C7C7CC); }

/* ---- Azioni inline ---- */
.corso-azioni {
    display: flex;
    gap: 6px;
    flex-shrink: 0;
}

/* ---- Rimuovi d-inline Bootstrap se presente ---- */
.d-inline { display: inline; }
</style>

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const checkboxes = document.querySelectorAll('.corso-checkbox');
    const selectAll = document.getElementById('selectAllCorsi');
    const barraAzioni = document.getElementById('barra-azioni');
    const contatore = document.getElementById('contatore-selezionati');

    function aggiornaUI() {
        const sel = document.querySelectorAll('.corso-checkbox:checked');
        const n = sel.length;
        if (n > 0) {
            barraAzioni.style.display = 'flex';
            contatore.textContent = n + (n === 1 ? ' selezionato' : ' selezionati');
        } else {
            barraAzioni.style.display = 'none';
        }
        // Aggiorna "seleziona tutti"
        if (selectAll) selectAll.checked = (n === checkboxes.length && n > 0);
    }

    checkboxes.forEach(cb => cb.addEventListener('change', aggiornaUI));

    if (selectAll) {
        selectAll.addEventListener('change', function() {
            checkboxes.forEach(cb => cb.checked = this.checked);
            aggiornaUI();
        });
    }

    // Azione multipla
    function postCorsi(url, confermaMsg) {
        const sel = Array.from(document.querySelectorAll('.corso-checkbox:checked')).map(cb => cb.value);
        if (sel.length === 0) { alert("‚ùå Nessun corso selezionato."); return; }
        if (!confirm(confermaMsg)) return;

        const csrfToken = document.getElementById('csrf_token')?.value;
        const formData = new URLSearchParams();
        sel.forEach(id => formData.append("corsi_selezionati[]", id));
        formData.append("csrf_token", csrfToken);

        fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: formData.toString()
        }).then(res => {
            if (res.ok) { window.location.reload(); }
            else { alert("‚ùå Errore nell'operazione."); }
        }).catch(() => alert("‚ùå Errore di connessione."));
    }

    const eliminaBtn = document.getElementById("elimina-corsi-button");
    if (eliminaBtn) {
        eliminaBtn.addEventListener("click", () =>
            postCorsi("{{ url_for('corsi.elimina_corsi_multipli') }}",
                "‚ùå Eliminare definitivamente i corsi selezionati e tutte le loro lezioni?")
        );
    }

    const archiviaBtn = document.getElementById("archivia-corsi-button");
    if (archiviaBtn) {
        archiviaBtn.addEventListener("click", () =>
            postCorsi("{{ url_for('corsi.archivia_corsi_multipli') }}",
                "üìÅ Archiviare i corsi selezionati?")
        );
    }
});
</script>
{% endblock %}
{% endblock %}
