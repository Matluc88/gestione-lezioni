{% extends "base_ios.html" %}

{% block title %}Verifica Conformit√† - {{ contratto.nome_file }}{% endblock %}

{% set large_title = "Verifica Conformit√†" %}

{% block content %}
<div class="ios-page">
    <!-- Header Info -->
    <div class="ios-card">
        <div class="ios-card-header">
            <h3 class="ios-card-title">üìã {{ contratto.nome_file }}</h3>
        </div>
        <div class="ios-card-body">
            <div class="info-grid">
                <div class="info-item">
                    <span class="info-label">Corso:</span>
                    <span class="info-value">{{ contratto.nome_corso }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Lezioni nel Contratto:</span>
                    <span class="info-value">{{ risultato.totale_contratto }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Lezioni nel Database:</span>
                    <span class="info-value">{{ risultato.totale_db }}</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Riepilogo (solo se c'√® un calendario) -->
    {% if risultato.totale_contratto > 0 %}
    <div class="summary-grid">
        <div class="summary-card success">
            <div class="summary-icon">‚úÖ</div>
            <div class="summary-number">{{ risultato.conformi|length }}</div>
            <div class="summary-label">Conformi</div>
        </div>
        
        <div class="summary-card warning">
            <div class="summary-icon">‚ö†Ô∏è</div>
            <div class="summary-number">{{ risultato.da_aggiungere|length }}</div>
            <div class="summary-label">Da Aggiungere</div>
        </div>
        
        <div class="summary-card info">
            <div class="summary-icon">‚ÑπÔ∏è</div>
            <div class="summary-number">{{ risultato.extra_db|length }}</div>
            <div class="summary-label">Extra in DB</div>
        </div>
        
        <div class="summary-card danger">
            <div class="summary-icon">üîÑ</div>
            <div class="summary-number">{{ risultato.differenze_orari|length }}</div>
            <div class="summary-label">Differenze Orari</div>
        </div>
    </div>

    <!-- Lezioni Conformi -->
    {% if risultato.conformi %}
    <div class="ios-card">
        <div class="ios-card-header" style="background-color: #34c759; color: white;">
            <h3 class="ios-card-title">‚úÖ Lezioni Conformi ({{ risultato.conformi|length }})</h3>
        </div>
        <div class="ios-card-body">
            <div class="lezioni-list">
                {% for item in risultato.conformi %}
                <div class="lezione-item conforme">
                    <div class="lezione-date">{{ item.contratto.data }}</div>
                    <div class="lezione-orario">{{ item.contratto.ora_inizio }} - {{ item.contratto.ora_fine }}</div>
                    <div class="lezione-status-container">
                        <span class="lezione-status">‚úì OK</span>
                        {% if item.suddiviso %}
                        <span class="badge-suddiviso" title="Lezione suddivisa nel contratto ma unica nel database">üîÄ Suddiviso</span>
                        {% endif %}
                    </div>
                    {% if item.suddiviso and item.contratto_dettaglio %}
                    <div class="lezione-suddivisione">
                        <small>Nel contratto:</small>
                        {% for lez_sub in item.contratto_dettaglio %}
                        <div class="sub-lezione">‚Üí {{ lez_sub.ora_inizio }} - {{ lez_sub.ora_fine }}</div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Lezioni Da Aggiungere -->
    {% if risultato.da_aggiungere %}
    <div class="ios-card">
        <div class="ios-card-header" style="background-color: #ff9500; color: white;">
            <h3 class="ios-card-title">‚ö†Ô∏è Da Aggiungere al Database ({{ risultato.da_aggiungere|length }})</h3>
        </div>
        <div class="ios-card-body">
            <p class="info-text">Queste lezioni sono presenti nel contratto ma non nel database:</p>
            <div class="lezioni-list">
                {% for lez in risultato.da_aggiungere %}
                <div class="lezione-item warning">
                    <div class="lezione-date">{{ lez.data }}</div>
                    <div class="lezione-orario">{{ lez.ora_inizio }} - {{ lez.ora_fine }}</div>
                    <div class="lezione-status">‚Üí Mancante</div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Lezioni Extra nel Database -->
    {% if risultato.extra_db %}
    <div class="ios-card">
        <div class="ios-card-header" style="background-color: #5ac8fa; color: white;">
            <h3 class="ios-card-title">‚ÑπÔ∏è Extra nel Database ({{ risultato.extra_db|length }})</h3>
        </div>
        <div class="ios-card-body">
            <p class="info-text">Queste lezioni sono nel database ma non nel contratto:</p>
            <div class="lezioni-list">
                {% for lez in risultato.extra_db %}
                <div class="lezione-item info">
                    <div class="lezione-date">{{ lez.data }}</div>
                    <div class="lezione-orario">{{ lez.ora_inizio }} - {{ lez.ora_fine }}</div>
                    <div class="lezione-status">‚Üê Extra</div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Differenze Orari -->
    {% if risultato.differenze_orari %}
    <div class="ios-card">
        <div class="ios-card-header" style="background-color: #ff3b30; color: white;">
            <h3 class="ios-card-title">üîÑ Differenze Orari ({{ risultato.differenze_orari|length }})</h3>
        </div>
        <div class="ios-card-body">
            <p class="info-text">Stessa data ma orari diversi:</p>
            <div class="lezioni-list">
                {% for item in risultato.differenze_orari %}
                <div class="lezione-item danger">
                    <div class="lezione-header">
                        <strong>{{ item.contratto.data }}</strong>
                    </div>
                    <div class="lezione-compare">
                        <div class="compare-side">
                            <div class="compare-label">üìÑ Contratto:</div>
                            <div class="compare-value">{{ item.contratto.ora_inizio }} - {{ item.contratto.ora_fine }}</div>
                        </div>
                        <div class="compare-separator">‚â†</div>
                        <div class="compare-side">
                            <div class="compare-label">üíæ Database:</div>
                            <div class="compare-value">{{ item.db.ora_inizio }} - {{ item.db.ora_fine }}</div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    {% endif %}{# fine: risultato.totale_contratto > 0 #}

    <!-- Calendario assente: confronto monte ore -->
    {% if risultato.totale_contratto == 0 %}
    {% if ore_contratto_estratte is not none %}
        {% set scarto = ((ore_db_totali - ore_contratto_estratte) | abs) %}
        {% if scarto <= 1.0 %}
        <!-- CONFORME -->
        <div class="ios-card ore-card ore-card--ok">
            <div class="ios-card-header ore-card-header ore-card-header--ok">
                <h3 class="ios-card-title">‚úÖ Calendario non presente ‚Äî Monte ore conforme</h3>
            </div>
            <div class="ios-card-body">
                <p class="info-text">
                    Il contratto non contiene un calendario dettagliato delle lezioni, ma il
                    <strong>monte ore √® coerente</strong> con le lezioni registrate nel database.
                </p>
                <div class="ore-compare-grid">
                    <div class="ore-compare-item">
                        <div class="ore-compare-label">üìÑ Contratto</div>
                        <div class="ore-compare-value">{{ ore_contratto_estratte | int }} h</div>
                    </div>
                    <div class="ore-compare-sep">=</div>
                    <div class="ore-compare-item">
                        <div class="ore-compare-label">üíæ Database</div>
                        <div class="ore-compare-value">{{ ore_db_totali }} h</div>
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <!-- NON CONFORME -->
        <div class="ios-card ore-card ore-card--warn">
            <div class="ios-card-header ore-card-header ore-card-header--warn">
                <h3 class="ios-card-title">‚ö†Ô∏è Calendario non presente ‚Äî Monte ore NON conforme</h3>
            </div>
            <div class="ios-card-body">
                <p class="info-text">
                    Il contratto non contiene un calendario dettagliato, e il
                    <strong>monte ore risulta diverso</strong> rispetto a quello registrato nel database.
                    Controlla se mancano lezioni o se il contratto √® stato aggiornato.
                </p>
                <div class="ore-compare-grid">
                    <div class="ore-compare-item">
                        <div class="ore-compare-label">üìÑ Contratto</div>
                        <div class="ore-compare-value">{{ ore_contratto_estratte | int }} h</div>
                    </div>
                    <div class="ore-compare-sep ore-compare-sep--diff">‚â†</div>
                    <div class="ore-compare-item">
                        <div class="ore-compare-label">üíæ Database</div>
                        <div class="ore-compare-value">{{ ore_db_totali }} h</div>
                    </div>
                </div>
                <div class="ore-scarto">
                    Scarto: <strong>{{ scarto | round(1) }} h</strong>
                </div>
            </div>
        </div>
        {% endif %}
    {% else %}
    <!-- Nessuna info trovata -->
    <div class="ios-card">
        <div class="ios-card-body" style="text-align: center; padding: 40px 20px;">
            <div style="font-size: 48px; margin-bottom: 15px;">üì≠</div>
            <h3>Calendario e monte ore non trovati</h3>
            <p style="color: var(--ios-text-secondary); margin-top: 10px;">
                Il sistema non √® riuscito a trovare n√© un calendario n√© le ore totali nel testo estratto
                dal contratto. Verifica che il PDF sia stato analizzato correttamente.
            </p>
        </div>
    </div>
    {% endif %}
    {% endif %}{# fine: totale_contratto == 0 #}

    <!-- Azioni -->
    <div class="ios-card">
        <div class="ios-card-body">
            <a href="{{ url_for('contratti.dettaglio_contratto', contratto_id=contratto.id) }}" 
               class="ios-button ios-button-primary ios-button-block">
                ‚Üê Torna al Contratto
            </a>
        </div>
    </div>
</div>

<style>
.info-grid {
    display: grid;
    gap: 12px;
}

.info-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid var(--ios-separator);
}

.info-item:last-child {
    border-bottom: none;
}

.info-label {
    font-size: 15px;
    color: var(--ios-text-secondary);
}

.info-value {
    font-size: 15px;
    font-weight: 600;
    color: var(--ios-text-primary);
}

.summary-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 15px;
    margin: 20px 0;
}

.summary-card {
    background: white;
    border-radius: var(--radius-lg);
    padding: 20px;
    text-align: center;
    box-shadow: var(--shadow-sm);
}

.summary-card.success {
    border-left: 4px solid #34c759;
}

.summary-card.warning {
    border-left: 4px solid #ff9500;
}

.summary-card.info {
    border-left: 4px solid #5ac8fa;
}

.summary-card.danger {
    border-left: 4px solid #ff3b30;
}

.summary-icon {
    font-size: 32px;
    margin-bottom: 8px;
}

.summary-number {
    font-size: 28px;
    font-weight: 700;
    color: var(--ios-text-primary);
    margin-bottom: 4px;
}

.summary-label {
    font-size: 13px;
    color: var(--ios-text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.info-text {
    font-size: 14px;
    color: var(--ios-text-secondary);
    margin-bottom: 15px;
    padding: 10px;
    background-color: var(--ios-background);
    border-radius: var(--radius-md);
}

.lezioni-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.lezione-item {
    padding: 15px;
    border-radius: var(--radius-md);
    background-color: var(--ios-background);
    border-left: 4px solid var(--ios-separator);
}

.lezione-item.conforme {
    border-left-color: #34c759;
    background-color: #f0fdf4;
}

.lezione-item.warning {
    border-left-color: #ff9500;
    background-color: #fff7ed;
}

.lezione-item.info {
    border-left-color: #5ac8fa;
    background-color: #f0f9ff;
}

.lezione-item.danger {
    border-left-color: #ff3b30;
    background-color: #fef2f2;
}

.lezione-date {
    font-size: 16px;
    font-weight: 600;
    color: var(--ios-text-primary);
    margin-bottom: 5px;
}

.lezione-orario {
    font-size: 14px;
    color: var(--ios-text-secondary);
}

.lezione-status-container {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 5px;
    flex-wrap: wrap;
}

.lezione-status {
    font-size: 13px;
    font-weight: 600;
    color: var(--ios-blue);
}

.badge-suddiviso {
    display: inline-block;
    padding: 3px 8px;
    background-color: #fff3cd;
    color: #856404;
    border: 1px solid #ffeaa7;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
    cursor: help;
}

.lezione-suddivisione {
    margin-top: 10px;
    padding: 10px;
    background-color: rgba(255, 255, 255, 0.5);
    border-radius: var(--radius-sm);
    border-left: 2px solid #ffd60a;
}

.lezione-suddivisione small {
    display: block;
    font-size: 12px;
    color: var(--ios-text-secondary);
    margin-bottom: 5px;
    font-weight: 600;
}

.sub-lezione {
    font-size: 13px;
    color: var(--ios-text-primary);
    padding: 3px 0;
    margin-left: 5px;
}

.lezione-header {
    font-size: 16px;
    margin-bottom: 10px;
}

.lezione-compare {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
}

.compare-side {
    flex: 1;
}

.compare-label {
    font-size: 12px;
    color: var(--ios-text-secondary);
    margin-bottom: 4px;
}

.compare-value {
    font-size: 14px;
    font-weight: 600;
    color: var(--ios-text-primary);
}

.compare-separator {
    font-size: 20px;
    font-weight: bold;
    color: #ff3b30;
}

/* ‚îÄ‚îÄ Blocco confronto monte ore (quando calendario assente) ‚îÄ‚îÄ */
.ore-card-header--ok {
    background-color: #34c759 !important;
    color: white;
}

.ore-card-header--warn {
    background-color: #ff9500 !important;
    color: white;
}

.ore-compare-grid {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 20px;
    padding: 20px 10px;
}

.ore-compare-item {
    text-align: center;
    flex: 1;
}

.ore-compare-label {
    font-size: 13px;
    color: var(--ios-text-secondary);
    margin-bottom: 6px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.ore-compare-value {
    font-size: 36px;
    font-weight: 700;
    color: var(--ios-text-primary);
}

.ore-compare-sep {
    font-size: 28px;
    font-weight: 700;
    color: #34c759;
    flex: 0;
    padding: 0 5px;
}

.ore-compare-sep--diff {
    color: #ff3b30;
}

.ore-scarto {
    margin-top: 12px;
    padding: 10px 14px;
    background-color: #fff3cd;
    border-radius: var(--radius-md);
    font-size: 14px;
    color: #856404;
    text-align: center;
}

@media (max-width: 768px) {
    .summary-grid {
        grid-template-columns: 1fr;
    }
    
    .lezione-compare {
        flex-direction: column;
        align-items: stretch;
    }
    
    .compare-separator {
        text-align: center;
        margin: 10px 0;
    }

    .ore-compare-grid {
        gap: 12px;
    }

    .ore-compare-value {
        font-size: 28px;
    }
}
</style>
{% endblock %}
