<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Aggiungi Fattura - Gestione Lezioni</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: linear-gradient(135deg, #d4c5b9 0%, #e8dfd6 100%); }
    .card { border-radius: 0; box-shadow: none; border: 1px solid #e0e0e0; }
    body {
      padding-top: 76px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    }
    .btn {
      border-radius: 0;
    }
    .form-control, .form-select {
      border-radius: 0;
    }
    .alert {
      border-radius: 0;
    }
    .form-label { font-weight: 500; }
    .btn-custom { background-color: #1a1a1a; color: white; border: none; border-radius: 0; }
    .btn-custom:hover { background-color: #a67c52; color: white; }
    .section-header { margin-top: 1rem; margin-bottom: 1rem; color: #1a1a1a; font-weight: bold; }
    .lezioni-container { max-height: 400px; overflow-y: auto; }
    
    @media (max-width: 768px) {
      .btn {
        min-height: 44px;
        margin-bottom: 0.5rem;
        padding: 12px 16px;
        font-size: 0.9rem;
      }
      .container {
        padding: 0 15px;
      }
      h4, h5 {
        font-size: 1.3rem;
        margin-bottom: 1rem;
      }
      .form-control, .form-select {
        min-height: 44px;
        font-size: 1rem;
      }
      .table-responsive {
        font-size: 0.85rem;
      }
      .lezioni-container {
        max-height: 300px;
      }
    }
    @media (max-width: 393px) {
      .btn {
        min-height: 48px;
        font-size: 0.85rem;
        padding: 14px 16px;
      }
      h4, h5 {
        font-size: 1.2rem;
      }
      .container {
        padding: 0 8px;
      }
      .form-control, .form-select {
        min-height: 48px;
        font-size: 16px;
      }
      .table-responsive {
        font-size: 0.8rem;
      }
      .lezioni-container {
        max-height: 250px;
      }
    }
  </style>
</head>
<body>
  {% include 'components/navbar_unified.html' %}

  <div class="container my-4">
    <div class="card shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h4>Inserisci i dettagli della fattura</h4>
          <a href="{{ url_for('fatture.index') }}" class="btn btn-secondary">‚Ü© Torna alle Fatture</a>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            {% for category, msg in messages %}
              <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                {{ msg }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
              </div>
            {% endfor %}
          {% endif %}
        {% endwith %}

        <form method="POST" enctype="multipart/form-data" class="row g-3">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          
          <div class="col-md-6">
            <label for="numero_fattura" class="form-label">Numero Fattura</label>
            <input type="text" class="form-control" id="numero_fattura" name="numero_fattura" required>
          </div>
          
          <!-- Removed complex course selection section -->
          
          <div class="col-md-6">
            <label for="data_fattura" class="form-label">Data Fattura</label>
            <input type="date" class="form-control" id="data_fattura" name="data_fattura" required value="{{ now.strftime('%Y-%m-%d') }}">
          </div>
          
          <div class="col-md-6">
            <label for="importo" class="form-label">Importo (‚Ç¨)</label>
            <input type="number" step="0.01" class="form-control" id="importo" name="importo" required>
          </div>
          
          <div class="col-md-6">
            <label for="tipo_fatturazione" class="form-label">Tipo Fatturazione</label>
            <select class="form-select" id="tipo_fatturazione" name="tipo_fatturazione" required>
              <option value="totale">Prestazione Occasionale</option>
              <option value="parziale">Partita IVA</option>
            </select>
          </div>
          
          <div class="col-md-6">
            <label for="file_pdf" class="form-label">File PDF Fattura</label>
            <input type="file" class="form-control" id="file_pdf" name="file_pdf" accept=".pdf">
            <div class="form-text">Opzionale: carica il file PDF della fattura</div>
          </div>
          
          <div class="col-12">
            <label for="note" class="form-label">Note</label>
            <textarea class="form-control" id="note" name="note" rows="3"></textarea>
          </div>
          
          <div class="col-12">
            <h5 class="section-header">Seleziona le lezioni da fatturare</h5>
            <div class="form-text mb-2">Seleziona le lezioni che vuoi includere in questa fattura</div>
            
            <!-- Filtri avanzati -->
            <div class="card mb-3">
              <div class="card-header bg-light">
                <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#filtriAvanzati">
                  üîç Filtri Avanzati
                </button>
              </div>
              <div class="collapse" id="filtriAvanzati">
                <div class="card-body">
                  <!-- Client-side filters -->
                  <div class="row g-3">
                    <div class="col-md-3">
                      <label class="form-label">Cliente</label>
                      <select class="form-select" id="filtro-cliente">
                        <option value="">Tutti i clienti</option>
                        {% for cliente in clienti %}
                          <option value="{{ cliente }}">{{ cliente }}</option>
                        {% endfor %}
                      </select>
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">Corso</label>
                      <select class="form-select" id="filtro-corso">
                        <option value="">Tutti i corsi</option>
                        {% for corso in corsi %}
                          <option value="{{ corso }}">{{ corso }}</option>
                        {% endfor %}
                      </select>
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">Mese</label>
                      <input type="month" class="form-control" id="filtro-mese">
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">Intervallo Date</label>
                      <div class="d-flex gap-2">
                        <input type="date" class="form-control" id="filtro-data-inizio" placeholder="Da">
                        <input type="date" class="form-control" id="filtro-data-fine" placeholder="A">
                      </div>
                    </div>
                  </div>
                  <div class="mt-3 text-end">
                    <button type="button" class="btn btn-primary" id="applica-filtri">Applica Filtri</button>
                    <button type="button" class="btn btn-outline-secondary" id="reset-filtri">Reset</button>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="lezioni-container">
              <table class="table table-striped table-hover">
                <thead class="table-primary">
                  <tr>
                    <th><input type="checkbox" id="select-all-lezioni" title="Seleziona/Deseleziona tutte le lezioni"></th>
                    <th>Corso</th>
                    <th>Cliente</th>
                    <th>Materia</th>
                    <th>Data</th>
                    <th>Orario</th>
                    <th>Compenso</th>
                  </tr>
                </thead>
                <tbody id="lezioni-tbody">
                  {% for lezione in lezioni %}
                    <tr data-cliente="{{ lezione.cliente|default('Sconosciuto') }}" data-data="{{ lezione.data }}">
                      <td>
                        <input type="checkbox" class="form-check-input" name="lezioni" value="{{ lezione.id }}" id="lezione_{{ lezione.id }}">
                      </td>
                      <td>{{ lezione.id_corso }}</td>
                      <td>{{ lezione.cliente|default('Sconosciuto') }}</td>
                      <td>{{ lezione.materia }}</td>
                      <td>{{ lezione.data }}</td>
                      <td>{{ lezione.ora_inizio }} - {{ lezione.ora_fine }}</td>
                      <td>‚Ç¨{{ lezione.compenso_orario }}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
          
          <div class="col-12 text-end">
            <button type="submit" class="btn btn-success btn-lg">‚úÖ Salva Fattura</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Elementi DOM
      const checkboxes = document.querySelectorAll('input[name="lezioni"]');
      const importoInput = document.getElementById('importo');
      const filtroCliente = document.getElementById('filtro-cliente');
      const filtroCorso = document.getElementById('filtro-corso');
      const filtroMese = document.getElementById('filtro-mese');
      const filtroDataInizio = document.getElementById('filtro-data-inizio');
      const filtroDataFine = document.getElementById('filtro-data-fine');
      const applicaFiltriBtn = document.getElementById('applica-filtri');
      const resetFiltriBtn = document.getElementById('reset-filtri');
      
      // DEFINIZIONE FUNZIONI (prima di tutto)
      function calcolaImportoTotale() {
        let importoTotale = 0;
        checkboxes.forEach(checkbox => {
          if (checkbox.checked) {
            const row = checkbox.closest('tr');
            const compensoText = row.querySelector('td:last-child').textContent;
            const compenso = parseFloat(compensoText.replace('‚Ç¨', '').trim());
            
            // Ottieni l'orario dalla riga
            const orarioText = row.querySelector('td:nth-child(6)').textContent;
            const [inizio, fine] = orarioText.split(' - ');
            
            // Calcola le ore
            const oraInizio = new Date(`2000-01-01T${inizio}`);
            const oraFine = new Date(`2000-01-01T${fine}`);
            const oreLezione = (oraFine - oraInizio) / (1000 * 60 * 60);
            
            importoTotale += compenso * oreLezione;
          }
        });
        
        importoInput.value = importoTotale.toFixed(2);
      }
      
      // Gestione filtri avanzati
      applicaFiltriBtn.addEventListener('click', applicaFiltri);
      resetFiltriBtn.addEventListener('click', resetFiltri);
      
      function applicaFiltri() {
        const cliente = filtroCliente.value;
        const corso = filtroCorso.value;
        const mese = filtroMese.value;
        const dataInizio = filtroDataInizio.value;
        const dataFine = filtroDataFine.value;
        
        console.log("Applicando filtri - Corso da filtrare:", corso);
        let visibili = 0;
        
        checkboxes.forEach(checkbox => {
          const row = checkbox.closest('tr');
          const corsoCella = row.querySelector('td:nth-child(2)').textContent.trim();
          const clienteCella = row.querySelector('td:nth-child(3)').textContent.trim();
          const dataCella = row.dataset.data;
          
          // Debug: stampa il primo corso trovato
          if (visibili === 0) {
            console.log("Primo corso nella tabella:", corsoCella, "- Confronto con:", corso, "- Match:", corsoCella === corso);
          }
          
          // Verifica se la riga corrisponde al corso selezionato (se c'√®)
          const corsoMatch = !corso || corsoCella === corso;
          
          // Verifica se la riga corrisponde al cliente selezionato (se c'√®)
          const clienteMatch = !cliente || clienteCella === cliente;
          
          // Verifica se la riga corrisponde al mese selezionato (se c'√®)
          let meseMatch = true;
          if (mese) {
            const meseDaFiltro = mese.split('-')[0] + '-' + mese.split('-')[1];
            const dateParts = dataCella.split('-');
            const dataLezione = new Date(parseInt(dateParts[0]), parseInt(dateParts[1]) - 1, parseInt(dateParts[2]));
            const meseDellaRiga = dataLezione.getFullYear() + '-' + String(dataLezione.getMonth() + 1).padStart(2, '0');
            meseMatch = meseDaFiltro === meseDellaRiga;
          }
          
          // Verifica se la riga √® nell'intervallo di date (se specificato)
          let dataMatch = true;
          if (dataInizio) {
            dataMatch = dataMatch && dataCella >= dataInizio;
          }
          if (dataFine) {
            dataMatch = dataMatch && dataCella <= dataFine;
          }
          
          // Mostra o nascondi la riga in base ai filtri
          if (corsoMatch && clienteMatch && meseMatch && dataMatch) {
            row.style.display = '';
            visibili++;
          } else {
            row.style.display = 'none';
            checkbox.checked = false;
          }
        });
        
        console.log("Lezioni visibili dopo filtro:", visibili);
        calcolaImportoTotale();
      }
      
      function resetFiltri() {
        filtroCliente.value = '';
        filtroCorso.value = '';
        filtroMese.value = '';
        filtroDataInizio.value = '';
        filtroDataFine.value = '';
        
        // Mostra tutte le lezioni
        checkboxes.forEach(checkbox => {
          const row = checkbox.closest('tr');
          row.style.display = '';
        });
        
        calcolaImportoTotale();
      }
      
      // Pre-selezione automatica se c'√® un corso o pi√π corsi nell'URL
      const urlParams = new URLSearchParams(window.location.search);
      const corsoPreselezionato = "{{ corso_preselezionato }}";
      const corsiPreselezionati = urlParams.get('corsi');
      
      console.log("Corso preselezionato dall'URL:", corsoPreselezionato);
      console.log("Corsi multipli preselezionati:", corsiPreselezionati);
      
      if (corsiPreselezionati) {
        // Gestione multi-corso (da stato_crediti)
        const corsiArray = corsiPreselezionati.split(',');
        console.log("Array corsi da fatturare:", corsiArray);
        
        // Filtra e seleziona tutte le lezioni dei corsi selezionati
        setTimeout(function() {
          checkboxes.forEach(checkbox => {
            const row = checkbox.closest('tr');
            const corsoCella = row.querySelector('td:nth-child(2)').textContent.trim();
            
            // Controlla se questo corso √® nella lista dei corsi preselezionati
            if (corsiArray.includes(corsoCella)) {
              row.style.display = '';
              checkbox.checked = true;
            } else {
              row.style.display = 'none';
              checkbox.checked = false;
            }
          });
          calcolaImportoTotale();
          
          // Espandi automaticamente i filtri per far vedere cosa √® stato applicato
          document.getElementById('filtriAvanzati').classList.add('show');
        }, 100);
        
      } else if (corsoPreselezionato) {
        // Gestione singolo corso (legacy)
        // Imposta il filtro corso
        filtroCorso.value = corsoPreselezionato;
        console.log("Valore impostato nel filtro:", filtroCorso.value);
        
        // Applica il filtro automaticamente
        applicaFiltri();
        
        // Seleziona tutte le checkbox del corso filtrato
        setTimeout(function() {
          checkboxes.forEach(checkbox => {
            const row = checkbox.closest('tr');
            if (row.style.display !== 'none') {
              checkbox.checked = true;
            }
          });
          calcolaImportoTotale();
          
          // Espandi automaticamente i filtri per far vedere cosa √® stato applicato
          document.getElementById('filtriAvanzati').classList.add('show');
        }, 100);
      }
      
      // Seleziona tutte le checkbox
      const selectAllCheckbox = document.getElementById("select-all-lezioni");
      if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener("change", function () {
          checkboxes.forEach(checkbox => {
            // Solo seleziona le checkbox visibili (non nascoste dai filtri)
            const row = checkbox.closest('tr');
            if (row.style.display !== 'none') {
              checkbox.checked = this.checked;
            }
          });
          calcolaImportoTotale();
        });
      }
      
      // Calcola l'importo totale in base alle lezioni selezionate
      checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', calcolaImportoTotale);
      });
      
      // Inizializza applicando i filtri
      applicaFiltri();
    });
  </script>
</body>
</html>
