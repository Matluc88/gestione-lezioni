<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <title>üìÖ Calendario Lezioni</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/it.js"></script>

    <style>
        body {
            background-color: #ffffff;
            padding-top: 76px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }
        .container {
            max-width: 90%;
        }
        h2 {
            color: #1a1a1a;
            font-weight: 600;
        }
        #calendar {
            background: white;
            border-radius: 0;
            padding: 15px;
            box-shadow: none;
            border: 1px solid #e0e0e0;
        }
        .fc-event-main {
            cursor: pointer;
        }
        .fc-toolbar-title {
            font-size: 1.8rem;
        }
        .fc .fc-button {
            font-size: 1.1rem;
            padding: 0.8rem 2.5rem;
            border-radius: 0;
            min-width: 120px;
        }
        .fc .fc-button-primary {
            background-color: #1a1a1a;
            border-color: #1a1a1a;
        }
        .fc .fc-button-primary:hover {
            background-color: #a67c52;
            border-color: #a67c52;
        }
        .fc-header-toolbar {
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        .fc .fc-toolbar-chunk {
            display: flex;
            gap: 1rem;
        }
        .btn {
            border-radius: 0;
        }
        .btn-secondary {
            background-color: #d4c5b9;
            color: #1a1a1a;
            border: none;
        }
        .btn-secondary:hover {
            background-color: #a67c52;
            color: #ffffff;
        }
        .alert {
            border-radius: 0;
        }
        @media (max-width: 768px) {
            .fc-header-toolbar {
                flex-direction: column;
                align-items: center;
            }
            .fc .fc-button {
                width: 100%;
                min-height: 44px;
                padding: 12px 16px;
            }
            .fc .fc-button-group {
                width: 100%;
                justify-content: center;
            }
            .btn {
                min-height: 44px;
                padding: 12px 16px;
            }
            .container {
                padding: 0 15px;
            }
            h2 {
                font-size: 1.5rem;
            }
        }
        @media (max-width: 480px) {
            .fc .fc-button {
                font-size: 0.9rem;
                padding: 10px 12px;
            }
            .btn {
                font-size: 0.95rem;
                padding: 12px 14px;
            }
            h2 {
                font-size: 1.3rem;
            }
        }
    </style>
</head>
<body>
<div class="container mt-4">
    <h2 class="text-center mb-4">üìÖ Calendario Lezioni</h2>
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="mb-3">
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <div class="d-flex justify-content-start mb-3">
        <a href="{{ url_for('lezioni.dashboard') }}" class="btn btn-secondary">üè† Torna alla Dashboard</a>
    </div>
    <div id="calendar"></div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    var calendarEl = document.getElementById('calendar');

    var calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'timeGridWeek',
        locale: 'it',
        themeSystem: 'bootstrap5',
        height: 'auto',
        allDaySlot: false,
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
        },
        events: {{ eventi | tojson | safe }},

        eventClick: function(info) {
            console.log("Evento cliccato:", info.event.title, info.event.id);
            let statoAttuale = info.event.extendedProps.stato;

            if (statoAttuale === 'Completato') {
                alert("Questa lezione √® gi√† segnata come completata.");
                return;
            }

            let conferma = confirm(`Vuoi segnare la lezione "${info.event.title}" come completata?`);

            if (conferma) {
                const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');

                if (!csrfToken) {
                    alert('‚ùå Errore: Token CSRF non trovato. Ricarica la pagina.');
                    console.error("CSRF Token non trovato nel meta tag!");
                    return;
                }

                fetch(`/completa_lezione/${info.event.id}`, {
                    method: "POST",
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => {
                    if (response.ok) {
                        alert("‚úÖ Lezione segnata come completata!");
                        window.location.reload();
                    } else {
                        alert(`‚ùå Errore ${response.status} durante l'aggiornamento. Riprova.`);
                        console.error("Errore dal server:", response.status, response.statusText);
                    }
                })
                .catch(error => {
                    console.error("‚ùå Errore durante la richiesta fetch:", error);
                    alert("‚ùå Errore di rete o di connessione durante l'aggiornamento.");
                });
            }
        }
    });

    calendar.render();

    // ‚úÖ Personalizza i testi dei pulsanti con emoji
    const oggiButton = document.querySelector('.fc-today-button');
    if (oggiButton) oggiButton.innerHTML = 'üìÖ Oggi';

    const prevButton = document.querySelector('.fc-prev-button');
    if (prevButton) prevButton.innerHTML = '‚¨ÖÔ∏è Indietro';

    const nextButton = document.querySelector('.fc-next-button');
    if (nextButton) nextButton.innerHTML = 'Avanti ‚û°Ô∏è';
});
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
