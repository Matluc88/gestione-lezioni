{% extends "base_ios.html" %}

{% block title %}Contratti{% endblock %}

{% set large_title = "Contratti" %}
{% set fab_url = url_for('contratti.nuovo_contratto') %}
{% set fab_title = "Carica Contratto" %}
{% set fab_icon = "üìÑ" %}

{% block navbar %}
    {% set title = "Contratti" %}
    {% include 'components/ios_navbar.html' %}
{% endblock %}

{% block content %}
<div class="ios-page">
    {% if contratti|length == 0 %}
    <div class="ios-empty-state">
        <div class="ios-empty-icon">üìÑ</div>
        <h3 class="ios-empty-title">Nessun contratto</h3>
        <p class="ios-empty-text">Carica il tuo primo contratto PDF per iniziare l'analisi con AI</p>
        <a href="{{ url_for('contratti.nuovo_contratto') }}" class="ios-button ios-button-primary">
            üìÑ Carica Contratto
        </a>
    </div>
    {% else %}

    {% if clienti|length > 0 %}
    <!-- Tab per cliente -->
    <div class="clienti-tab-bar">
        <div class="clienti-tab-scroll">
            <button class="cliente-tab active" data-cliente="tutti" onclick="filtraCliente('tutti', this)">
                Tutti
                <span class="cliente-tab-count">{{ contratti|length }}</span>
            </button>
            {% for cliente in clienti %}
            <button class="cliente-tab" data-cliente="{{ cliente }}" onclick="filtraCliente('{{ cliente }}', this)">
                üë§ {{ cliente }}
                <span class="cliente-tab-count">{{ contratti | selectattr('cliente', 'equalto', cliente) | list | length }}</span>
            </button>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <div class="ios-list-group" id="lista-contratti">
        {% for contratto in contratti %}
        <a href="{{ url_for('contratti.dettaglio_contratto', contratto_id=contratto.id) }}"
           class="ios-list-item contratto-item"
           data-cliente="{{ contratto.cliente or '' }}">
            <span class="ios-list-icon">üìÑ</span>
            <div class="ios-list-content">
                <div class="ios-list-title">
                    {{ contratto.nome_file }}
                    {% if contratto.numero_contratto %}
                    <span class="ios-badge">{{ contratto.numero_contratto }}</span>
                    {% endif %}
                </div>
                <div class="ios-list-subtitle">
                    {% if contratto.cliente %}
                    üë§ {{ contratto.cliente }}
                    {% endif %}
                    {% if contratto.nome_corso %}
                    ‚Ä¢ üìö {{ contratto.nome_corso }}
                    {% endif %}
                </div>
                <div class="ios-list-meta">
                    üìÖ {{ contratto.data_upload[:10] }}
                </div>
            </div>
            <span class="ios-list-chevron"></span>
        </a>
        {% endfor %}
    </div>

    <!-- Stato vuoto per filtro -->
    <div class="ios-empty-state" id="empty-filtro" style="display:none;">
        <div class="ios-empty-icon">üîç</div>
        <h3 class="ios-empty-title">Nessun contratto</h3>
        <p class="ios-empty-text">Nessun contratto trovato per questo cliente</p>
    </div>

    {% endif %}
</div>

<style>
/* ---- Tab bar clienti ---- */
.clienti-tab-bar {
    margin: 12px 16px 4px;
    overflow: hidden;
}

.clienti-tab-scroll {
    display: flex;
    gap: 8px;
    overflow-x: auto;
    padding-bottom: 4px;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
}

.clienti-tab-scroll::-webkit-scrollbar {
    display: none;
}

.cliente-tab {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 7px 14px;
    border-radius: 20px;
    border: none;
    background-color: var(--ios-gray5, #E5E5EA);
    color: var(--ios-label, #000);
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    white-space: nowrap;
    transition: background-color 0.18s, color 0.18s;
    -webkit-tap-highlight-color: transparent;
    font-family: var(--font-system, -apple-system, BlinkMacSystemFont, sans-serif);
}

.cliente-tab.active {
    background-color: var(--ios-blue, #007AFF);
    color: white;
}

.cliente-tab-count {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 20px;
    height: 20px;
    padding: 0 6px;
    border-radius: 10px;
    font-size: 12px;
    font-weight: 600;
    background-color: rgba(255,255,255,0.25);
}

.cliente-tab:not(.active) .cliente-tab-count {
    background-color: var(--ios-gray3, #C7C7CC);
    color: white;
}

/* ---- Meta riga data ---- */
.ios-list-meta {
    font-size: 12px;
    color: var(--ios-gray, #8E8E93);
    margin-top: 2px;
}

/* ---- Empty state ---- */
.ios-empty-state {
    text-align: center;
    padding: 60px 20px;
    margin-top: 40px;
}

.ios-empty-icon {
    font-size: 80px;
    margin-bottom: 20px;
    opacity: 0.3;
}

.ios-empty-title {
    font-size: 24px;
    font-weight: 600;
    margin-bottom: 10px;
    color: var(--ios-text-primary);
}

.ios-empty-text {
    font-size: 16px;
    color: var(--ios-text-secondary);
    margin-bottom: 30px;
    line-height: 1.5;
}

.ios-badge {
    display: inline-block;
    padding: 2px 8px;
    background-color: var(--ios-blue);
    color: white;
    border-radius: 10px;
    font-size: 12px;
    font-weight: 600;
    margin-left: 8px;
}

/* Nasconde item senza animazione brusca */
.contratto-item.nascosto {
    display: none;
}
</style>

{% block extra_js %}
<script>
function filtraCliente(cliente, btn) {
    // Aggiorna tab attivo
    document.querySelectorAll('.cliente-tab').forEach(t => t.classList.remove('active'));
    btn.classList.add('active');

    const items = document.querySelectorAll('.contratto-item');
    let visibili = 0;

    items.forEach(item => {
        if (cliente === 'tutti' || item.dataset.cliente === cliente) {
            item.classList.remove('nascosto');
            visibili++;
        } else {
            item.classList.add('nascosto');
        }
    });

    // Mostra/nascondi stato vuoto
    const emptyFiltro = document.getElementById('empty-filtro');
    const lista = document.getElementById('lista-contratti');
    if (emptyFiltro && lista) {
        if (visibili === 0) {
            lista.style.display = 'none';
            emptyFiltro.style.display = 'flex';
        } else {
            lista.style.display = '';
            emptyFiltro.style.display = 'none';
        }
    }
}
</script>
{% endblock %}
{% endblock %}
