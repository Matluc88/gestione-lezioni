{% extends "base_ios.html" %}

{% block title %}{{ contratto.nome_file }}{% endblock %}

{% set large_title = "Dettaglio Contratto" %}

{% block content %}
<div class="ios-page">
    <!-- Informazioni Contratto -->
    <div class="ios-card">
        <div class="ios-card-header">
            <h3 class="ios-card-title">üìÑ {{ contratto.nome_file }}</h3>
        </div>
        <div class="ios-card-body">
            <!-- Pulsante Download PDF -->
            <a href="{{ url_for('contratti.download_contratto', contratto_id=contratto.id) }}" 
               class="ios-button ios-button-primary ios-button-block download-pdf-btn"
               style="margin-bottom: 20px;">
                üì• Scarica PDF
            </a>
            
            <div class="info-grid">
                {% if contratto.numero_contratto %}
                <div class="info-item">
                    <span class="info-label">Numero:</span>
                    <span class="info-value">{{ contratto.numero_contratto }}</span>
                </div>
                {% endif %}
                
                {% if contratto.cliente %}
                <div class="info-item">
                    <span class="info-label">Cliente:</span>
                    <span class="info-value">{{ contratto.cliente }}</span>
                </div>
                {% endif %}
                
                <div class="info-item">
                    <span class="info-label">Data Upload:</span>
                    <span class="info-value">{{ contratto.data_upload[:10] }}</span>
                </div>
                
                {% if contratto.nome_corso %}
                <div class="info-item">
                    <span class="info-label">Corso Collegato:</span>
                    <span class="info-value">üìö {{ contratto.nome_corso }}</span>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Analisi AI -->
    <div class="ios-card analysis-card">
        <div class="ios-card-header">
            <h3 class="ios-card-title">ü§ñ Analisi AI</h3>
        </div>
        <div class="ios-card-body">
            <div class="analysis-content">{{ analysis }}</div>
        </div>
    </div>

    <!-- Chat AI -->
    <div class="ios-card chat-card">
        <div class="ios-card-header">
            <h3 class="ios-card-title">üí¨ Fai una domanda al contratto</h3>
        </div>
        <div class="ios-card-body">
            <!-- Chat Messages -->
            <div id="chatMessages" class="chat-messages">
                <div class="chat-intro">
                    <div class="chat-intro-icon">üí°</div>
                    <p>Fai domande in linguaggio naturale come:</p>
                    <div class="example-questions">
                        <button class="example-btn" onclick="askQuestion('Dammi il numero del corso')">
                            Dammi il numero del corso
                        </button>
                        <button class="example-btn" onclick="askQuestion('Qual √® il compenso orario?')">
                            Qual √® il compenso orario?
                        </button>
                        <button class="example-btn" onclick="askQuestion('Quali sono le date del contratto?')">
                            Quali sono le date?
                        </button>
                        <button class="example-btn" onclick="askQuestion('Quante ore sono previste?')">
                            Quante ore sono previste?
                        </button>
                    </div>
                </div>
            </div>

            <!-- Input Chat -->
            <form id="chatForm" class="chat-input-form" onsubmit="sendMessage(event)">
                <input type="text" 
                       id="chatInput" 
                       class="chat-input" 
                       placeholder="Scrivi la tua domanda..."
                       autocomplete="off">
                <button type="submit" class="chat-send-btn" id="sendBtn">
                    <span class="send-icon">‚û§</span>
                </button>
            </form>
        </div>
    </div>

    <!-- Azioni -->
    <div class="ios-card">
        <div class="ios-card-body">
            <!-- Collega/Modifica Corso -->
            <form method="POST" action="{{ url_for('contratti.collega_corso', contratto_id=contratto.id) }}" class="corso-form">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="ios-form-group">
                    <label class="ios-label">Collega a Corso</label>
                    <select class="ios-select" name="id_corso" onchange="this.form.submit()">
                        <option value="">-- Nessun corso --</option>
                        {% for corso in corsi %}
                        <option value="{{ corso.id_corso }}" {% if contratto.id_corso == corso.id_corso %}selected{% endif %}>
                            {{ corso.nome }}{% if corso.cliente %} ({{ corso.cliente }}){% endif %}
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </form>

            <!-- Elimina Contratto -->
            <form method="POST" action="{{ url_for('contratti.elimina_contratto', contratto_id=contratto.id) }}" 
                  onsubmit="return confirm('Sei sicuro di voler eliminare questo contratto? Questa azione non pu√≤ essere annullata.')"
                  style="margin-top: 20px;">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" class="ios-button ios-button-danger ios-button-block">
                    üóëÔ∏è Elimina Contratto
                </button>
            </form>
        </div>
    </div>
</div>

<style>
.info-grid {
    display: grid;
    gap: 15px;
}

.info-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 0;
    border-bottom: 1px solid var(--ios-separator);
}

.info-item:last-child {
    border-bottom: none;
}

.info-label {
    font-size: 15px;
    color: var(--ios-text-secondary);
}

.info-value {
    font-size: 15px;
    font-weight: 600;
    color: var(--ios-text-primary);
    text-align: right;
}

.analysis-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.analysis-content {
    white-space: pre-wrap;
    line-height: 1.6;
    font-size: 15px;
}

.chat-card {
    margin-bottom: 80px;
}

.chat-messages {
    min-height: 300px;
    max-height: 500px;
    overflow-y: auto;
    padding: 15px;
    background-color: var(--ios-background);
    border-radius: var(--radius-md);
    margin-bottom: 15px;
}

.chat-intro {
    text-align: center;
    padding: 20px;
}

.chat-intro-icon {
    font-size: 48px;
    margin-bottom: 15px;
}

.chat-intro p {
    font-size: 15px;
    color: var(--ios-text-secondary);
    margin-bottom: 20px;
}

.example-questions {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.example-btn {
    padding: 12px 16px;
    background: var(--ios-card-background);
    border: 1px solid var(--ios-separator);
    border-radius: var(--radius-md);
    font-size: 14px;
    color: var(--ios-blue);
    cursor: pointer;
    transition: all 0.2s;
    text-align: left;
}

.example-btn:hover {
    background-color: var(--ios-blue);
    color: white;
    transform: translateY(-2px);
}

.chat-message {
    margin-bottom: 15px;
    animation: messageSlideIn 0.3s ease-out;
}

@keyframes messageSlideIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.chat-message-user {
    text-align: right;
}

.chat-bubble {
    display: inline-block;
    max-width: 80%;
    padding: 12px 16px;
    border-radius: 18px;
    font-size: 15px;
    line-height: 1.4;
    word-wrap: break-word;
}

.chat-bubble-user {
    background-color: var(--ios-blue);
    color: white;
    border-bottom-right-radius: 4px;
}

.chat-bubble-ai {
    background-color: var(--ios-card-background);
    color: var(--ios-text-primary);
    border-bottom-left-radius: 4px;
}

.chat-input-form {
    display: flex;
    gap: 10px;
}

.chat-input {
    flex: 1;
    padding: 12px 16px;
    font-size: 16px;
    border: 1px solid var(--ios-separator);
    border-radius: 24px;
    background-color: var(--ios-background);
    color: var(--ios-text-primary);
}

.chat-input:focus {
    outline: none;
    border-color: var(--ios-blue);
}

.chat-send-btn {
    width: 48px;
    height: 48px;
    border-radius: 24px;
    background-color: var(--ios-blue);
    color: white;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}

.chat-send-btn:hover {
    transform: scale(1.05);
}

.chat-send-btn:active {
    transform: scale(0.95);
}

.chat-send-btn:disabled {
    background-color: var(--ios-separator);
    cursor: not-allowed;
}

.send-icon {
    font-size: 20px;
}

.loading-indicator {
    display: inline-block;
    padding: 12px 16px;
    background-color: var(--ios-card-background);
    border-radius: 18px;
    color: var(--ios-text-secondary);
}

.loading-dots {
    display: inline-block;
}

.loading-dots span {
    animation: loadingDots 1.4s infinite;
    opacity: 0;
}

.loading-dots span:nth-child(1) { animation-delay: 0s; }
.loading-dots span:nth-child(2) { animation-delay: 0.2s; }
.loading-dots span:nth-child(3) { animation-delay: 0.4s; }

@keyframes loadingDots {
    0%, 60%, 100% { opacity: 0; }
    30% { opacity: 1; }
}

.curso-form {
    margin-bottom: 0;
}

.ios-button-danger {
    background-color: #ff3b30;
    color: white;
}

.ios-button-danger:hover {
    background-color: #ff2d20;
}
</style>

<script>
const chatMessages = document.getElementById('chatMessages');
const chatInput = document.getElementById('chatInput');
const chatForm = document.getElementById('chatForm');
const sendBtn = document.getElementById('sendBtn');
const contrattoId = {{ contratto.id }};

function askQuestion(question) {
    chatInput.value = question;
    sendMessage(new Event('submit'));
}

async function sendMessage(event) {
    event.preventDefault();
    
    const question = chatInput.value.trim();
    if (!question) return;
    
    // Rimuovi intro se presente
    const intro = chatMessages.querySelector('.chat-intro');
    if (intro) {
        intro.remove();
    }
    
    // Aggiungi messaggio utente
    addMessage(question, 'user');
    chatInput.value = '';
    chatInput.disabled = true;
    sendBtn.disabled = true;
    
    // Aggiungi indicatore di caricamento
    const loadingId = addLoadingIndicator();
    
    try {
        // Chiamata API
        const response = await fetch(`/contratti/${contrattoId}/chat`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'
            },
            body: JSON.stringify({ question: question })
        });
        
        const data = await response.json();
        
        // Rimuovi loading
        removeLoadingIndicator(loadingId);
        
        if (data.success) {
            addMessage(data.answer, 'ai');
        } else {
            addMessage('‚ùå Errore: ' + data.error, 'ai');
        }
    } catch (error) {
        removeLoadingIndicator(loadingId);
        addMessage('‚ùå Errore di connessione', 'ai');
    } finally {
        chatInput.disabled = false;
        sendBtn.disabled = false;
        chatInput.focus();
    }
}

function addMessage(text, type) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `chat-message ${type === 'user' ? 'chat-message-user' : ''}`;
    
    const bubbleDiv = document.createElement('div');
    bubbleDiv.className = `chat-bubble chat-bubble-${type}`;
    bubbleDiv.textContent = text;
    
    messageDiv.appendChild(bubbleDiv);
    chatMessages.appendChild(messageDiv);
    
    // Scroll to bottom
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function addLoadingIndicator() {
    const loadingDiv = document.createElement('div');
    loadingDiv.className = 'chat-message';
    loadingDiv.id = 'loading-' + Date.now();
    
    const loadingBubble = document.createElement('div');
    loadingBubble.className = 'loading-indicator';
    loadingBubble.innerHTML = '<div class="loading-dots"><span>.</span><span>.</span><span>.</span></div>';
    
    loadingDiv.appendChild(loadingBubble);
    chatMessages.appendChild(loadingDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
    
    return loadingDiv.id;
}

function removeLoadingIndicator(id) {
    const loading = document.getElementById(id);
    if (loading) {
        loading.remove();
    }
}
</script>
{% endblock %}
