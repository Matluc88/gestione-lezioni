<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aggiungi Lezioni (Date Multiple NON consecutive)</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/material_blue.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            background: #ffffff;
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            padding-top: 76px;
        }
        .container {
            background: #ffffff;
            border-radius: 0;
            box-shadow: none;
            margin-top: 20px;
            margin-bottom: 20px;
            padding: 30px;
        }
        .btn {
            border-radius: 0;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
            box-shadow: none;
            border: none;
        }
        .btn-primary {
            background-color: #1a1a1a;
            color: #ffffff;
        }
        .btn-primary:hover {
            background-color: #a67c52;
            color: #ffffff;
        }
        .btn-success {
            background-color: #1a1a1a;
            color: #ffffff;
        }
        .btn-success:hover {
            background-color: #a67c52;
            color: #ffffff;
        }
        .btn-secondary {
            background-color: #d4c5b9;
            color: #1a1a1a;
        }
        .btn-secondary:hover {
            background-color: #a67c52;
            color: #ffffff;
        }
        .btn-danger {
            background-color: #dc3545;
            color: #ffffff;
        }
        .btn-danger:hover {
            background-color: #c82333;
        }
        .card {
            border: 1px solid #e0e0e0;
            border-radius: 0;
            box-shadow: none;
            transition: none;
        }
        .card:hover {
            transform: none;
        }
        .form-control, .form-select {
            border-radius: 0;
            border: 1px solid #e0e0e0;
            transition: all 0.3s ease;
        }
        .form-control:focus, .form-select:focus {
            border-color: #a67c52;
            box-shadow: 0 0 0 0.2rem rgba(166, 124, 82, 0.25);
        }
        h1, h2, h3 {
            color: #1a1a1a;
            font-weight: 600;
        }
        .alert {
            border-radius: 0;
            border: none;
        }
        .flatpickr-input {
            border-radius: 0 !important;
            border: 1px solid #e0e0e0 !important;
        }
        
        @media (max-width: 768px) {
            .btn {
                min-height: 44px;
                margin-bottom: 0.5rem;
                padding: 12px 16px;
                font-size: 0.9rem;
                letter-spacing: 0.5px;
            }
            .container {
                padding: 15px;
                margin-top: 10px;
                margin-bottom: 10px;
            }
            h1, h2, h3 {
                font-size: 1.5rem;
                margin-bottom: 1rem;
            }
            .form-control, .form-select {
                min-height: 44px;
                font-size: 1rem;
            }
            .card {
                margin-bottom: 1rem;
            }
            .form-label {
                font-weight: 600;
                margin-bottom: 0.5rem;
            }
        }
        @media (max-width: 480px) {
            .btn {
                font-size: 0.85rem;
                padding: 12px 14px;
            }
            h1, h2, h3 {
                font-size: 1.3rem;
            }
            .container {
                padding: 10px;
            }
        }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/it.js"></script>

    <script>
        // Array per memorizzare le date selezionate
        let dateSelezionate = [];
        
        // Funzione che apre il calendario per selezionare date multiple
        function selezionaDateCalendario() {
            // Crea un elemento input temporaneo per il calendario
            const tempInput = document.createElement('input');
            document.body.appendChild(tempInput);
            
            // Inizializza flatpickr sul campo temporaneo
            const fp = flatpickr(tempInput, {
                mode: "multiple",
                dateFormat: "Y-m-d",
                locale: "it",
                inline: false,
                position: "auto",
                showMonths: 2,
                weekNumbers: true,
                altInput: true,
                altFormat: "j F Y",
                theme: "material_blue",
                closeOnSelect: false,
                onChange: function() {
                    // Aggiorna il contatore delle date selezionate
                    const count = this.selectedDates.length;
                    document.getElementById('dateCounter').textContent = count;
                },
                onClose: function(selectedDates, dateStr, instance) {
                    // Quando l'utente chiude il calendario, salva le date selezionate
                    if (selectedDates.length > 0) {
                        for (let date of selectedDates) {
                            // Usa il fuso orario locale invece di UTC per evitare problemi di conversione
                            const year = date.getFullYear();
                            const month = String(date.getMonth() + 1).padStart(2, '0');
                            const day = String(date.getDate()).padStart(2, '0');
                            const formattedDate = `${year}-${month}-${day}`; // Formato YYYY-MM-DD
                            if (!dateSelezionate.includes(formattedDate)) {
                                dateSelezionate.push(formattedDate);
                            }
                        }
                        // Aggiorna la visualizzazione delle date
                        aggiornaListaDate();
                    }
                    
                    // Rimuovi l'input temporaneo
                    document.body.removeChild(tempInput);
                    // Nascondi il contatore
                    document.getElementById('calendarModal').style.display = 'none';
                    
                    // Mostra il pannello delle date selezionate
                    document.getElementById('dateSelezionatePanel').style.display = 'block';
                }
            });
            
            // Mostra il calendario
            fp.open();
            
            // Mostra il contatore delle date selezionate
            document.getElementById('calendarModal').style.display = 'block';
        }
        
        // Funzione per aggiornare la lista delle date selezionate
        function aggiornaListaDate() {
            const container = document.getElementById('dateSelezionateList');
            container.innerHTML = '';
            
            // Ordina le date
            dateSelezionate.sort();
            
            // Crea un elemento per ogni data
            dateSelezionate.forEach((data, index) => {
                const dateParts = data.split('-');
                const dataObj = new Date(parseInt(dateParts[0]), parseInt(dateParts[1]) - 1, parseInt(dateParts[2]));
                const dataFormattata = dataObj.toLocaleDateString('it-IT', { 
                    weekday: 'short', 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric' 
                });
                
                const item = document.createElement('div');
                item.className = 'date-item';
                item.innerHTML = `
                    <span>${dataFormattata}</span>
                    <button type="button" class="btn btn-sm btn-danger" onclick="rimuoviData(${index})">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                container.appendChild(item);
            });
            
            // Aggiorna il contatore
            document.getElementById('dateCount').textContent = dateSelezionate.length;
            
            // Abilita/disabilita il pulsante di inserimento
            document.getElementById('btnInserisciLezioni').disabled = dateSelezionate.length === 0;
        }
        
        // Funzione per rimuovere una data dall'elenco
        function rimuoviData(index) {
            dateSelezionate.splice(index, 1);
            aggiornaListaDate();
        }
        
        // Funzione per creare le righe di lezione per tutte le date selezionate
        function inserisciLezioni() {
            const container = document.getElementById("lezioniContainer");
            
            // Rimuovi tutte le righe esistenti
            container.innerHTML = '';
            
            // Crea una riga per ogni data selezionata
            dateSelezionate.forEach(data => {
                const riga = document.createElement('div');
                riga.className = 'row row-lezione g-2 align-items-center mb-2';
                riga.innerHTML = `
                    <div class="col-md-2 col-6">
                        <select name="id_corso[]" class="form-select" required>
                            <option value="" disabled selected>Seleziona corso</option>
                            {% for c in corsi %}
                               <option value="{{ c.id_corso }}">{{ c.nome }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2 col-6">
                        <input type="text" name="materia[]" class="form-control" placeholder="Materia" required>
                    </div>
                    <div class="col-md-2 col-6">
                        <input type="date" name="data[]" class="form-control" value="${data}" readonly>
                    </div>
                    <div class="col-md-1 col-3">
                        <input type="time" name="ora_inizio[]" class="form-control">
                    </div>
                    <div class="col-md-1 col-3">
                        <input type="time" name="ora_fine[]" class="form-control">
                    </div>
                    <div class="col-md-1 col-6">
                        <input type="text" name="luogo[]" class="form-control" placeholder="Luogo">
                    </div>
                    <div class="col-md-1 col-6">
                        <input type="number" name="compenso_orario[]" step="0.01" class="form-control" placeholder="‚Ç¨/ora">
                    </div>
                    <div class="col-md-1 col-6">
                        <select name="stato[]" class="form-select">
                            <option value="Pianificato" selected>Pianificato</option>
                            <option value="Confermato">Confermato</option>
                            <option value="Completato">Completato</option>
                            <option value="Cancellato">Cancellato</option>
                        </select>
                    </div>
                    <div class="col-md-1 col-6 d-flex align-items-center">
                        <button type="button" class="btn btn-sm btn-danger" onclick="this.parentNode.parentNode.remove()">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                container.appendChild(riga);
            });
            
            // Nascondi il pannello delle date selezionate
            document.getElementById('dateSelezionatePanel').style.display = 'none';
            
            // Mostra il form di inserimento
            document.getElementById('lezioniForm').style.display = 'block';
            
            // Inizializza flatpickr su tutti gli input di data
            document.querySelectorAll('input[name="data[]"]').forEach(input => {
                flatpickr(input, {
                    dateFormat: "Y-m-d",
                    locale: "it",
                    altInput: true,
                    altFormat: "j F Y",
                    theme: "material_blue",
                    // Imposta l'ora a mezzogiorno per evitare problemi di timezone
                    defaultHour: 12
                });
            });
        }
        
        // Funzione per copiare i valori dalla prima riga a tutte le altre
        function copiaValoriPrimaRiga() {
            const righe = document.querySelectorAll('.row-lezione');
            if (righe.length <= 1) return;
            
            const primaRiga = righe[0];
            
            // Ottieni i valori con controlli di sicurezza
            const corsoElement = primaRiga.querySelector('select[name="id_corso[]"]');
            const materiaElement = primaRiga.querySelector('input[name="materia[]"]');
            const luogoElement = primaRiga.querySelector('input[name="luogo[]"]');
            const compensoElement = primaRiga.querySelector('input[name="compenso_orario[]"]');
            const oraInizioElement = primaRiga.querySelector('input[name="ora_inizio[]"]');
            const oraFineElement = primaRiga.querySelector('input[name="ora_fine[]"]');
            const statoElement = primaRiga.querySelector('select[name="stato[]"]');
            
            // Estrai i valori solo se gli elementi esistono
            const corso = corsoElement ? corsoElement.value : '';
            const materia = materiaElement ? materiaElement.value : '';
            const luogo = luogoElement ? luogoElement.value : '';
            const compenso = compensoElement ? compensoElement.value : '';
            const oraInizio = oraInizioElement ? oraInizioElement.value : '';
            const oraFine = oraFineElement ? oraFineElement.value : '';
            const stato = statoElement ? statoElement.value : '';
            
            // Applica i valori a tutte le altre righe con controlli di sicurezza
            for (let i = 1; i < righe.length; i++) {
                const corsoTarget = righe[i].querySelector('select[name="id_corso[]"]');
                const materiaTarget = righe[i].querySelector('input[name="materia[]"]');
                const luogoTarget = righe[i].querySelector('input[name="luogo[]"]');
                const compensoTarget = righe[i].querySelector('input[name="compenso_orario[]"]');
                const oraInizioTarget = righe[i].querySelector('input[name="ora_inizio[]"]');
                const oraFineTarget = righe[i].querySelector('input[name="ora_fine[]"]');
                const statoTarget = righe[i].querySelector('select[name="stato[]"]');
                
                if (corsoTarget && corso) corsoTarget.value = corso;
                if (materiaTarget && materia) materiaTarget.value = materia;
                if (luogoTarget && luogo) luogoTarget.value = luogo;
                if (compensoTarget && compenso) compensoTarget.value = compenso;
                if (oraInizioTarget && oraInizio) oraInizioTarget.value = oraInizio;
                if (oraFineTarget && oraFine) oraFineTarget.value = oraFine;
                if (statoTarget && stato) statoTarget.value = stato;
            }
        }
        
        // Verifica se la data √® nel passato
        function verificaDataPassata(inputElement) {
            const dateParts = inputElement.value.split('-');
            const dataSelezionata = new Date(parseInt(dateParts[0]), parseInt(dateParts[1]) - 1, parseInt(dateParts[2]));
            const oggi = new Date();
            oggi.setHours(0, 0, 0, 0); // Resetta l'ora a mezzanotte per confrontare solo le date
            
            if (dataSelezionata < oggi) {
                inputElement.classList.add('border-warning');
                inputElement.setAttribute('data-passata', 'true');
            } else {
                inputElement.classList.remove('border-warning');
                inputElement.removeAttribute('data-passata');
            }
        }
        
        // Verifica tutte le date prima dell'invio del form
        function verificaDatePrimaDiInviare(event) {
            const form = event.target;
            const inputsData = form.querySelectorAll('input[name="data[]"]');
            let datePassate = [];
            
            inputsData.forEach(input => {
                if (input.value) {
                    const dateParts = input.value.split('-');
                    const dataSelezionata = new Date(parseInt(dateParts[0]), parseInt(dateParts[1]) - 1, parseInt(dateParts[2]));
                    const oggi = new Date();
                    oggi.setHours(0, 0, 0, 0);
                    
                    if (dataSelezionata < oggi) {
                        datePassate.push(input.value);
                    }
                }
            });
            
            if (datePassate.length > 0) {
                const conferma = confirm(`‚ö†Ô∏è ATTENZIONE: Stai inserendo ${datePassate.length} lezione/i in data/e passata/e (${datePassate.join(', ')}). Vuoi continuare?`);
                if (!conferma) {
                    event.preventDefault();
                }
            }
        }
        
        // Inizializza gli eventi quando il documento √® pronto
        document.addEventListener('DOMContentLoaded', function() {
            // Aggiungi l'evento submit al form
            document.querySelector('form').addEventListener('submit', verificaDatePrimaDiInviare);
        });
    </script>
    <style>
        .col-md-1.d-flex.align-items-center {
            padding-top: 1.5rem;
        }
        input[data-passata="true"] {
            background-color: #fff3cd;
        }
        #calendarModal {
            position: fixed;
            top: 86px;
            right: 10px;
            background-color: #1a1a1a;
            color: white;
            padding: 10px 15px;
            border-radius: 0;
            z-index: 9999;
            display: none;
            box-shadow: none;
        }
        .flatpickr-calendar {
            box-shadow: none !important;
            border: 1px solid #e0e0e0 !important;
        }
        #dateSelezionatePanel {
            display: none;
            margin-bottom: 20px;
        }
        .date-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            margin-bottom: 5px;
            background-color: #f8f9fa;
            border-radius: 0;
            border: 1px solid #dee2e6;
        }
        #lezioniForm {
            display: none;
        }
        
        /* Stili per dispositivi mobili */
        @media (max-width: 768px) {
            .row-lezione {
                margin-bottom: 15px;
                padding-bottom: 15px;
                border-bottom: 1px solid #dee2e6;
            }
            .col-md-1, .col-md-2 {
                margin-bottom: 10px;
            }
            .btn {
                padding: 10px 15px;
                font-size: 16px;
            }
            .form-control, .form-select {
                height: 45px;
                font-size: 16px;
            }
        }
    </style>
</head>

<body>
<div class="container mt-4">
    <h2 class="text-center mb-4">‚ûï Aggiungi Lezioni (Date NON consecutive)</h2>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, msg in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ msg }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <!-- Contatore date selezionate -->
    <div id="calendarModal">
        <strong>Date selezionate: <span id="dateCounter">0</span></strong>
    </div>
    
    <!-- Pannello date selezionate -->
    <div id="dateSelezionatePanel" class="card p-4 shadow-sm">
        <h4 class="mb-3">Date selezionate (<span id="dateCount">0</span>)</h4>
        <div id="dateSelezionateList" class="mb-3"></div>
        <div class="d-flex justify-content-between">
            <button type="button" class="btn btn-primary" onclick="selezionaDateCalendario()">
                üìÖ Aggiungi altre date
            </button>
            <button type="button" id="btnInserisciLezioni" class="btn btn-success" onclick="inserisciLezioni()" disabled>
                ‚úÖ Inserisci lezioni
            </button>
        </div>
    </div>

    <form method="POST" class="card p-4 shadow-sm" id="lezioniForm">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

        <div id="lezioniContainer">
            <!-- Le righe di lezione verranno aggiunte dinamicamente -->
        </div>

        <hr class="my-3">
        
        <div class="d-flex flex-wrap gap-2 justify-content-between">
            <button type="button" class="btn btn-primary" onclick="copiaValoriPrimaRiga()">
                üìã Copia valori dalla prima riga
            </button>
            
            <div class="ms-auto">
                <a href="{{ url_for('lezioni.dashboard') }}" class="btn btn-secondary">‚Ü© Annulla</a>
                <button type="submit" class="btn btn-success">‚úÖ Salva Lezioni</button>
            </div>
        </div>
    </form>
    
    <!-- Pulsante per iniziare la selezione delle date -->
    <div class="text-center mt-4">
        <button type="button" class="btn btn-lg btn-primary" onclick="selezionaDateCalendario()" id="btnSelezionaDate">
            üìÖ Seleziona Date dal Calendario
        </button>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
